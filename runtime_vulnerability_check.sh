#!/bin/bash

# Step 1: Run docker-bench-security.sh and print the output to a text file
cd /root/Docker/docker-bench/docker-bench-security/docker-bench-security
./docker-bench-security.sh > /root/script/docker-bench-output.txt

# Step 2: Print main points of the output and add user input to select a specific point
echo $'\n'"Select a point to view warnings:"$'\n'
echo "1 - Host Configuration"
echo "2 - Docker daemon configuration"
echo "3 - Docker daemon configuration files"
echo "4 - Container Images and Build File"
echo "5 - Container Runtime"$'\n'
read -p "Enter the number of the section you want to view: " section

if [ "$section" -eq 1 ]; then
	echo $'\n'"Warnings for Host Configuration :-"$'\n'
	cat /root/script/docker-bench-output.txt | grep 'WARN.* 1\.'
	echo $'\n'

elif [ "$section" -eq 2 ]; then
	echo $'\n'"Warnings for Docker Daemon Configuration :-"$'\n'
        cat /root/script/docker-bench-output.txt | grep 'WARN.* 2\.'
	echo $'\n'

elif [ "$section" -eq 3 ]; then
    	echo $'\n'"Warnings for Docker Daemon Configuration Files :-"$'\n'
    	grep 'WARN.* 3\.' /root/script/docker-bench-output.txt
	echo $'\n'

elif [ "$section" -eq 4 ]; then
    	echo $'\n'"Warnings for Container Images and Build File :-"$'\n'
	cat /root/script/docker-bench-output.txt | awk '/4 - Container Images and Build File/,/5 - Container Runtime/' | grep 'WARN'
	echo $'\n'

elif [ "$section" -eq 5 ]; then
	cat /root/script/docker-bench-output.txt | awk '/5 - Container Runtime/,/6 - Docker Security Operations/' > /root/script/container-runtime.txt
    	echo $'\n'"Current running containers :-"$'\n'
	docker ps --format "table {{.ID}}\t{{.Image}}\t{{.Names}}"
	echo $'\n'
	read -p "Enter the container Name to view specific warnings: " container_name

	while IFS= read -r line; do
        # Check if the line is a warning header for section 5
        if [[ "$line" == *"5."* ]]; then
            warning_line="$line"
            continue
        fi
        # Check if the line contains the container name and if there's a stored warning line
        if [[ "$line" == *"$container_name"* && -n "$warning_line" ]]; then
		if [[ "$line" == *"[WARN]"* ]];then
            		echo $'\n'"$warning_line"
            		echo "$line"$'\n'
            		warning_line=""
		fi
        fi

    	done < /root/script/container-runtime.txt

else
    echo "Invalid selection"
fi

